services:
  # Rostering Service (your existing service)
  rostering:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rostering
    ports:
      - "3005:3005"

    env_file:
      - .env  # This will load all variables from the .env file
    depends_on:
      rostering-db:
        condition: service_healthy
      rostering-redis:
        condition: service_healthy
      ortools-optimizer:
        condition: service_healthy
    volumes:
      - rostering-logs:/app/logs
    networks:
      - auth_service_default
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "const http = require('http'); const options = { hostname: 'localhost', port: 3005, path: '/health', timeout: 2000 }; const req = http.request(options, (res) => { process.exit(res.statusCode === 200 ? 0 : 1); }); req.on('error', () => process.exit(1)); req.end();"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # NEW: OR-Tools Python Optimizer Service
  ortools-optimizer:
    build:
      context: ./ortools
      dockerfile: Dockerfile
    container_name: ortools-optimizer
    ports:
      - "5000:5000"
    env_file:
      - .env
    environment:
      LOG_LEVEL: ${ORTOOLS_LOG_LEVEL}
    networks:
      - auth_service_default
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 70s
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 2G
        reservations:
          cpus: '2'
          memory: 1G

  # ... (rest of your existing services)
  rostering-db:
    image: postgis/postgis:15-3.3
    container_name: rostering-db
    env_file:
      - .env
    ports:
      - "5450:5432"
    volumes:
      - rostering-db-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - auth_service_default
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d rostering_dev"]
      interval: 10s
      timeout: 5s
      retries: 5

  rostering-redis:
    image: redis:7-alpine
    container_name: rostering-redis
    ports:
      - "6390:6379"
    volumes:
      - rostering-redis-data:/data
    networks:
      - auth_service_default
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru

  adminer:
    image: adminer:latest
    container_name: rostering-adminer
    ports:
      - "8083:8080"
    env_file:
      - .env
    networks:
      - auth_service_default
    restart: unless-stopped
    depends_on:
      - rostering-db

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: rostering-redis-commander
    ports:
      - "8084:8081"
    env_file:
      - .env
    networks:
      - auth_service_default
    restart: unless-stopped
    depends_on:
      - rostering-redis

volumes:
  rostering-db-data:
    driver: local
  rostering-redis-data:
    driver: local
  rostering-logs:
    driver: local

networks:
  auth_service_default:
    external: true